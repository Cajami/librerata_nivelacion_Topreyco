<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css">

    <style>
        input[type="text"] {
            text-align: center;
            text-transform: uppercase;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="row mt-4">
            <div class="col-sm-12 font-weight-bold text-center text-danger">
                <h2>LIBRETA DE NIVELACIÓN</h2>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-sm-12 text-right">
                <div class="btn btn-success btn-sm float-left" id="btnAgregar">
                    <i class="far fa-plus-square"></i>
                    Agregar
                </div>
                <div class="btn btn-danger btn-sm float-left" id="btnExportarExcel" style="margin-left: 10px;">
                    <i class="far fa-file-excel"></i>
                    Exportar Excel
                </div>
                <button class="btn btn-primary" id="btnCalcular">
                    <i class="fas fa-calculator"></i>
                    Calcular
                </button>
                <button class="btn btn-secundary" id="btnLimpiar">
                    <i class="far fa-file"></i>
                    Limpiar
                </button>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-sm-12">
                <table class="table table-bordered" id="tablaLibreta">
                    <thead class="text-center font-weight-bold bg-info">
                        <tr>
                            <th></th>
                            <th>HITO</th>
                            <th>PTO-VISADO</th>
                            <th>V-ATRÁS</th>
                            <th>V-INT</th>
                            <th>V-ADEL</th>
                            <th>ALT-INST</th>
                            <th>COTA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><i class="fas fa-list-ul"></i></td>
                            <td>
                                <input type="text" class="form-control">
                            </td>
                            <td>
                                <input type="text" class="form-control">
                            </td>
                            <td>
                                <input type="text" class="form-control">
                            </td>
                            <td>
                                <input type="text" class="form-control">
                            </td>
                            <td>
                                <input type="text" class="form-control">
                            </td>
                            <td class="text-center">
                            </td>
                            <td>
                                <input type="text" class="form-control">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

        <iframe id="txtArea1" style="display:none"></iframe>

        <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
        <script>
            $('#btnAgregar').on('click', function () {
                $('#tablaLibreta').append('<tr>' +
                    '<td class="text-center"><i class="far fa-trash-alt text-danger eliminarRegistro"></i></td>' +
                    '<td>' +
                    '<input type="text" class="form-control">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control">' +
                    '</td>' +
                    '<td class="text-center">' +
                    '</td>' +
                    '<td class="text-center">' +
                    '</td>' +
                    '</tr>');
            });

            $('#btnCalcular').on('click', function () {
                var ALT_INST = 'ALT-INST';
                var hito, ptoVisado, vInt, vAdel;
                var vAtras = 0;
                var cota = 0;
                var cota_anterior = 0;

                $('#tablaLibreta tbody tr').each(function (index, elemento) {
                    debugger;
                    vAtras = $(elemento).find('td:eq(3) input').val().trim();

                    if (vAtras.length == 0 || vAtras == 0) {
                        //PRIMERO ALT_INST Y DESPUES COTA
                        $(elemento).find('td:eq(6)').text(ALT_INST);

                        if (index > 0) {
                            vInt = $(elemento).find('td:eq(4) input').val().trim();
                            if (vInt.length == 0 || vInt == 0) {
                                vAdel = $(elemento).find('td:eq(5) input').val().trim();

                                cota = parseFloat(ALT_INST) - parseFloat(vAdel);
                            } else {
                                cota = parseFloat(ALT_INST) - parseFloat(vInt);
                            }
                            cota = parseFloat(parseFloat(cota).toFixed(3));
                        }

                    } else {
                        //PRIMERO COTA Y DESPUES ALT_INST

                        if (index > 0) {
                            vAdel = $(elemento).find('td:eq(5) input').val().trim();
                            if (vAdel.length == 0 || vAdel == 0) {
                                cota = parseFloat(cota_anterior);
                            } else {
                                cota = parseFloat(ALT_INST) - parseFloat(vAdel);
                            }
                        } else {
                            cota = parseFloat($(elemento).find('td:eq(7) input').val().trim());
                        }
                        cota = parseFloat(parseFloat(cota).toFixed(3));

                        ALT_INST = parseFloat(parseFloat(parseFloat(vAtras) + cota).toFixed(3));
                        $(elemento).find('td:eq(6)').text(ALT_INST);
                    }

                    if (index > 0)
                        $(elemento).find('td:eq(7)').text(cota);

                    cota_anterior = cota;
                });
            });

            $('#tablaLibreta tbody').on('click', 'i.eliminarRegistro', function () {
                $(this).closest('tr').remove();
            });

            $('#btnLimpiar').on('click', function () {
                var $tabla = $('#tablaLibreta tbody');
                $tabla.find('tr:not(:first)').remove();
                var $tr = $tabla.find('tr');
                $tr.find('td:eq(1) input').val('');
                $tr.find('td:eq(2) input').val('');
                $tr.find('td:eq(3) input').val('');
                $tr.find('td:eq(4) input').val('');
                $tr.find('td:eq(5) input').val('');
                $tr.find('td:eq(6)').text('');
                $tr.find('td:eq(7) input').val('');
            });

            $('#btnExportarExcel').on('click', function () {
                var dataExportar = '<table border="2px">' +
                    '<tr>' +
                    '<td bgcolor="#87AFC6">HITO</td>' +
                    '<td bgcolor="#87AFC6">PTO-VISADO</td>' +
                    '<td bgcolor="#87AFC6">V-ATRAS</td>' +
                    '<td bgcolor="#87AFC6">V-INT</td>' +
                    '<td bgcolor="#87AFC6">V-ADEL</td>' +
                    '<td bgcolor="#87AFC6">ALT-INST</td>' +
                    '<td bgcolor="#87AFC6">COTA</td>' +
                    '</tr>';

                var cota = '';

                $('#tablaLibreta tbody tr').each(function (index, elemento) {

                    if (index == 0)
                        cota = $(elemento).find('td:eq(7) input').val().trim();
                    else
                        cota = $(elemento).find('td:eq(7)').val().trim();

                    dataExportar += '<tr>' +
                        '<td>' + $(elemento).find('td:eq(1) input').val().trim() + '</td>' +
                        '<td>' + $(elemento).find('td:eq(2) input').val().trim() + '</td>' +
                        '<td>' + $(elemento).find('td:eq(3) input').val().trim() + '</td>' +
                        '<td>' + $(elemento).find('td:eq(4) input').val().trim() + '</td>' +
                        '<td>' + $(elemento).find('td:eq(5) input').val().trim() + '</td>' +
                        '<td>' + $(elemento).find('td:eq(5)').val().trim() + '</td>' +
                        '<td>' + cota + '</td>' +
                        '</tr>';
                });
                dataExportar += '</table>';
                fnExcelReport(dataExportar);
            });

            function fnExcelReport(tab_text) {
                tab_text = tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
                tab_text = tab_text.replace(/<img[^>]*>/gi, ""); // remove if u want images in your table
                tab_text = tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

                var ua = window.navigator.userAgent;
                var msie = ua.indexOf("MSIE ");

                if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
                {
                    txtArea1.document.open("txt/html", "replace");
                    txtArea1.document.write(tab_text);
                    txtArea1.document.close();
                    txtArea1.focus();
                    sa = txtArea1.document.execCommand("SaveAs", true, "Say Thanks to Sumit.xls");
                }
                else                 //other browser not tested on IE 11
                    sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));

                return (sa);
            }

        </script>
</body>

</html>